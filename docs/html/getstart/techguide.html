<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Technical guide &mdash; Factorio Updater Documentation 0.1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contribute" href="contribute.html" />
    <link rel="prev" title="User guide" href="userguide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Factorio Updater Documentation
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../info/index.html">Information</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Getting started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="userguide.html">User guide</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Technical guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#script-options">Script options</a></li>
<li class="toctree-l3"><a class="reference internal" href="#case-1-self-test">Case 1 - self-test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#case-2-normal-operation">Case 2 - normal operation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contribute.html">Contribute</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Documentation API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Factorio Updater Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Getting started</a></li>
      <li class="breadcrumb-item active">Technical guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/getstart/techguide.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="technical-guide">
<h1>Technical guide<a class="headerlink" href="#technical-guide" title="Permalink to this heading"></a></h1>
<p>Here I’d like to explain a little bit how the code is structured and what is the program flow.</p>
<p>The main file, <code class="docutils literal notranslate"><span class="pre">FactorioUpdater.php</span></code> parses options given to the script from the command line. Based on them, it decides what to do. There are two “cases”, i.e. two decisions the script can do, apart from exiting due to an error/exception.</p>
<section id="script-options">
<h2>Script options<a class="headerlink" href="#script-options" title="Permalink to this heading"></a></h2>
<p>Here are the options:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>--stable<span class="w">      </span>Required.<span class="w"> </span>One<span class="w"> </span>of:
<span class="w">              </span>stable,<span class="w"> </span>experimental
--rootdir<span class="w">     </span>Required.<span class="w"> </span>Absolute<span class="w"> </span>path<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>root<span class="w"> </span>folder<span class="w"> </span>of
<span class="w">              </span>a<span class="w"> </span>Factorio<span class="w"> </span>installation.
--no-install<span class="w">  </span>Optional.<span class="w"> </span>Do<span class="w"> </span>not<span class="w"> </span>download/install<span class="w"> </span>updates<span class="w"> </span><span class="k">if</span>
<span class="w">              </span>a<span class="w"> </span>newer<span class="w"> </span>version<span class="w"> </span>exists.
--test<span class="w">        </span>Optional.<span class="w"> </span>Indicates<span class="w"> </span>a<span class="w"> </span><span class="nb">test</span><span class="w"> </span>run<span class="w"> </span>that<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>use
<span class="w">              </span>actual<span class="w"> </span>Factorio<span class="w"> </span>installation<span class="w"> </span>or<span class="w"> </span>API,<span class="w"> </span>rather<span class="w"> </span>it
<span class="w">              </span>uses<span class="w"> </span>mocks<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span><span class="nb">test</span><span class="w"> </span>folder<span class="w"> </span><span class="k">for</span><span class="w"> </span>API<span class="w"> </span>responses,
<span class="w">              </span>Factorio<span class="w"> </span>binary<span class="w"> </span>and<span class="w"> </span>update<span class="w"> </span>packages.<span class="w"> </span>This<span class="w"> </span>checks
<span class="w">              </span>that<span class="w"> </span>the<span class="w"> </span>script<span class="w"> </span>behaves<span class="w"> </span>as<span class="w"> </span>expected<span class="w"> </span>regarding<span class="w"> </span>the
<span class="w">              </span>API<span class="w"> </span>calls<span class="w"> </span>and<span class="w"> </span>putting<span class="w"> </span>together<span class="w"> </span>+<span class="w"> </span>applying<span class="w"> </span>the
<span class="w">              </span>update<span class="w"> </span>sequence<span class="w"> </span>with<span class="w"> </span>checking<span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span>of<span class="w"> </span>the
<span class="w">              </span>program.
<span class="w">              </span>Using<span class="w"> </span>this<span class="w"> </span>option<span class="w"> </span>ignores<span class="w"> </span>--package,<span class="w"> </span>--build,
<span class="w">              </span>--stable,<span class="w"> </span>--rootdir<span class="w"> </span>and<span class="w"> </span>--no-install<span class="w"> </span>options.
--quiet<span class="w">       </span>Optional.<span class="w"> </span><span class="s2">&quot;Do not print anything, just do your job.&quot;</span>
</pre></div>
</div>
</section>
<section id="case-1-self-test">
<h2>Case 1 - self-test<a class="headerlink" href="#case-1-self-test" title="Permalink to this heading"></a></h2>
<p>If the option <code class="docutils literal notranslate"><span class="pre">--test</span></code> is present, all other options except for <code class="docutils literal notranslate"><span class="pre">--quiet</span></code> are ignored, including your secrets in the <code class="docutils literal notranslate"><span class="pre">.env</span></code> file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">--quiet</span></code> option is good for automation scripts which basically need just the exit code of the script (either successful 0 or erroneous 1).</p>
<p>Self-test uses a mock Factorio binary <code class="docutils literal notranslate"><span class="pre">tests/factroot/bin/x64/factorio</span></code> and mock Factorio API <code class="docutils literal notranslate"><span class="pre">tests/assets/*.json</span></code> to just test that the scripts behaves as expected.</p>
<p>What it does is that for all combinations of stability (currently <code class="docutils literal notranslate"><span class="pre">stable</span></code> and <code class="docutils literal notranslate"><span class="pre">experimental</span></code>) it tries to update the mock Factorio installation in <code class="docutils literal notranslate"><span class="pre">tests/factroot</span></code> from version “1.0.0” to the newest version (“1.1.0” for stable, “1.1.1” for experimental).</p>
<p>The mock Factorio API, represented by JSON files in <code class="docutils literal notranslate"><span class="pre">tests/asssets</span></code>, has the same format and structure as the normal API. It reports hardcoded versions “1.0.0”, “1.0.1”, “1.1.0” and “1.1.1”. There are also update packages in the same folder “1.0.0-&gt;1.0.1”, “1.0.1-&gt;1.1.0” and “1.1.0-&gt;1.1.1” that the script can download and apply.</p>
<p>The mock Factorio binary responds to two cli options, <code class="docutils literal notranslate"><span class="pre">--version</span></code> and <code class="docutils literal notranslate"><span class="pre">--apply-update</span> <span class="pre">&lt;path&gt;</span></code>. The first option causes it to output the content of the file <code class="docutils literal notranslate"><span class="pre">tests/factroot/bin/x64/version</span></code> to stdout, while the latter overwrites the content of the version file with the file given in the option’s value.</p>
<p>So thanks to these mocks the script uses completely the same flow as it does during normal operation (described below) and we can ensure that the behaviour and effect of the scripts operation is as expected.</p>
<p>After the test is finished, successfully or not, the script exits and does not continue with any other operations.</p>
</section>
<section id="case-2-normal-operation">
<h2>Case 2 - normal operation<a class="headerlink" href="#case-2-normal-operation" title="Permalink to this heading"></a></h2>
<p>If the option <code class="docutils literal notranslate"><span class="pre">--test</span></code> is <em>not</em> present, the options above marked as “Required” really must be present, because they give the script all necessary information for downloading correct updates.</p>
<p>The file <code class="docutils literal notranslate"><span class="pre">FactorioUpdater.php</span></code> really just creates a new instance of the class <code class="xref php php-class docutils literal notranslate"><span class="pre">TMD\FUPD\FactorioUpdate</span></code> (specifically, it calls its method <code class="xref php php-meth docutils literal notranslate"><span class="pre">TMD\FUPD\FactorioUpdate::run</span></code>). All the actual code is present in that class.</p>
<p>The method does all the checks of the option values given to it, so it won’t continue if e.g. the Factorio root directory is not writable for the script.</p>
<p>If all options seem fine, it first downloads the list of latest releases (API) and compares it with the version that Factorio binary reports with <code class="docutils literal notranslate"><span class="pre">--version</span></code>. If the version strings are the same, all is fine and the script exits.</p>
<p>If the version strings are different <em>and</em> the option <code class="docutils literal notranslate"><span class="pre">--no-install</span></code> is not present, it continues with downloading the list of all available update packages (API). Since these updates are always from one version to the version immediately following it, it might need to construct a “sequence” of updates that lead to the particular latest releases, meaning that it apply each update package until, eventually, the local version is the same as the latest one.</p>
<p>There might be some strange situations that the script cannot find a correct sequence - in that case it doesn’t download any package and just exits with an error.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">local</span> <span class="n">version</span><span class="p">:</span> <span class="mf">1.2.3</span>
<span class="n">latest</span> <span class="n">release</span><span class="p">:</span> <span class="mf">1.2.4</span>
<span class="n">update</span> <span class="n">sequence</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1.2.3-&gt;1.2.4&quot;</span><span class="p">]</span>

<span class="n">local</span> <span class="n">version</span><span class="p">:</span> <span class="mf">1.2.3</span>
<span class="n">latest</span> <span class="n">release</span><span class="p">:</span> <span class="mf">2.0.0</span>
<span class="n">update</span> <span class="n">sequence</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1.2.3-&gt;1.2.4&quot;</span><span class="p">,</span> <span class="s2">&quot;1.2.4-&gt;2.0.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>If the sequence was found successfully, it proceeds to ask the API for download links, one by one, download them, apply and continue with the next update package.</p>
<p>Potentially, if the script fails during this update loop, you may be left with a version that is not the latest and not your previous local version either. That allows the script to continue with the update after the error is resolved and it does not have to download some updates again, so the API has a little bit less traffic.</p>
<p>Finally, if all updates have been applied, it repeats the check of the latest release and the local version. If these version strings are the same, all is fine and the script exits. Otherwise, it reports an error.</p>
<p>That’s it, folks.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="userguide.html" class="btn btn-neutral float-left" title="User guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="contribute.html" class="btn btn-neutral float-right" title="Contribute" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Tommander.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>